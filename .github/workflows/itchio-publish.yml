# Nombre del flujo de trabajo
name: Publish to Itch.io

# Cuándo se debe ejecutar
on:
  # Ejecutar cada vez que haces push a la rama 'master' o 'main'
  push:
    branches: ["master", "main"]

# Los trabajos (tareas) a realizar
jobs:
  deploy:
    # Usar la última versión de Ubuntu para ejecutar el trabajo
    runs-on: ubuntu-latest

    steps:
      # 1. Descarga tu código del repositorio
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2. Exporta el juego usando la acción de Godot
      - name: Godot Export
        id: export # Le damos un ID para usar sus resultados luego
        uses: firebelley/godot-export@v5.2.1
        with:
          # --- URLs para Godot 4.5 (como menciona el artículo) ---
          godot_executable_download_url: https://github.com/godotengine/godot/releases/download/4.5-stable/Godot_v4.5-stable_linux.x86_64.zip
          
          # NOTA: El artículo tenía un pequeño error de formato aquí.
          # Este es el parámetro correcto para las plantillas de exportación:
          godot_export_templates_download_url: https://github.com/godotengine/godot/releases/download/4.5-stable/Godot_v4.5-stable_export_templates.tpz

          # Ruta a la carpeta de tu proyecto (si está en la raíz, es ./)
          relative_project_path: ./
          
          # Comprime la salida en un .zip (¡perfecto para Itch.io!)
          archive_output: true
          
          # Guarda Godot en caché para ejecuciones más rápidas
          cache: true
        env:
          # Pasamos el token de GitHub que guardamos en los secretos
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

# 3. Sube el juego a Itch.io (VERSIÓN NUEVA)
      - name: Butler Push
        uses: yeslayla/butler-publish-itchio-action@v1.0.3
        with:
          # La clave API (el nombre del secreto es el mismo)
          butler-api-key: ${{ secrets.ITCHIO_TOKEN }}
          
          # Tu usuario y juego (¡recuerda editarlos!)
          itch-user: tu-usuario-itch
          itch-game: mi-juego-genial

          # ¡Esta es la parte importante!
          # En lugar de adivinar por el nombre del archivo,
          # le decimos a qué canal subirlo. Para HTML5, usa 'html5' o 'web'.
          itch-channel: html5

          # La versión (igual que antes)
          version: ${{ github.ref_name }}

          # La ruta al archivo .zip (igual que antes)
          # (¡Recuerda editar 'mi-juego-web.zip'!)
          package-path: "${{ steps.export.outputs.archive_directory }}/build.zip"
